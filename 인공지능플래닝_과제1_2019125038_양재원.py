# -*- coding: utf-8 -*-
"""á„‹á…µá†«á„€á…©á†¼á„Œá…µá„‚á…³á†¼á„‘á…³á†¯á„…á…¢á„‚á…µá†¼_á„€á…ªá„Œá…¦1_2019125038_á„‹á…£á†¼á„Œá…¢á„‹á…¯á†«.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SnUxlja7gRYUNvW4eesWEORZqXYlQplG
"""

from ortools.sat.python import cp_model

import os
os.listdir()

from google.colab import files
uploaded = files.upload()

import pandas as pd
fname = next(iter(uploaded))
df = pd.read_csv(fname, encoding='utf-8-sig')
df.head()

import pandas as pd
from math import floor, ceil

df = pd.read_csv('á„’á…¡á†¨á„€á…³á†¸á„‡á…¡á†«á„‘á…§á†«á„‰á…¥á†¼CSP á„†á…®á†«á„Œá…¦ á„‹á…µá†¸á„…á…§á†¨á„‘á…¡á„‹á…µá†¯.csv')
df.head()

df.info()
df.describe(include="all")

# Boolean ì»¬ëŸ¼ ì²˜ë¦¬
def to_bool(s):
    return str(s).strip().lower() == 'yes'

for col in ['Leadership', 'Piano', 'ë¹„ë“±êµ', 'ìš´ë™ì„ í˜¸']:
    df[col] = df[col].apply(to_bool)

# ê´€ê³„ id ì²˜ë¦¬
def id_or_none(v):
    try:
        if pd.isna(v): return None
        return int(v)
    except:
        return None

df['ì¢‹ì€ê´€ê³„'] = df['ì¢‹ì€ê´€ê³„'].apply(id_or_none)
df['ë‚˜ìœê´€ê³„'] = df['ë‚˜ìœê´€ê³„'].apply(id_or_none)

# ì „ë…„ë„/í´ëŸ½ ê²°ì¸¡ê°’ ì±„ìš°ê¸°
df['24ë…„ í•™ê¸‰'] = df['24ë…„ í•™ê¸‰'].fillna('ë¯¸ì§€ì •').astype(str)
df['í´ëŸ½'] = df['í´ëŸ½'].fillna('ë¯¸ì§€ì •').astype(str)

df.head()

n = len(df)                       # í•™ìƒ ìˆ˜ = 200
num_classes = 6
class_size = [33,33,33,33,34,34]

id_to_idx = {int(r.id): i for i, r in df.iterrows()}

# ê· ë“± ë¶„ë°° ë²”ìœ„ í•¨ìˆ˜
def bounds(total, k=num_classes):
    return floor(total/k), ceil(total/k)

model = cp_model.CpModel()

# x[i][c] : í•™ìƒ iê°€ ë°˜ cì— ë°°ì •ë˜ë©´ 1
x = [[model.NewBoolVar(f'x_{i}_{c}') for c in range(num_classes)] for i in range(n)]

# (ê¸°ë³¸) ê° í•™ìƒì€ ì •í™•íˆ í•œ ë°˜
for i in range(n):
    model.Add(sum(x[i][c] for c in range(num_classes)) == 1)

# ê° ë°˜ ì •ì› (33,33,33,33,34,34)
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in range(n)) == class_size[c])

# (1) ë¬¸ì œ ì•„ë™ ë°°ì¹˜
for i, row in df.iterrows():
    bad_id = row['ë‚˜ìœê´€ê³„']
    if bad_id is not None and bad_id in id_to_idx:
        j = id_to_idx[bad_id]
        for c in range(num_classes):
            model.Add(x[i][c] + x[j][c] <= 1)

    if row['ë¹„ë“±êµ']:
        good_id = row['ì¢‹ì€ê´€ê³„']
        if good_id is not None and good_id in id_to_idx:
            j = id_to_idx[good_id]
            for c in range(num_classes):
                model.Add(x[i][c] == x[j][c])

# (2) ë¦¬ë”ì‹­ ìµœì†Œ 1ëª…
leaders = df.index[df['Leadership']].tolist()
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in leaders) >= 1)

# (3) í”¼ì•„ë…¸ ê· ë“±
pianos = df.index[df['Piano']].tolist()
lb, ub = bounds(len(pianos))
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in pianos) >= lb)
    model.Add(sum(x[i][c] for i in pianos) <= ub)

# (4) ì„±ì  ê· í˜•
scores = df['score'].astype(int).tolist()
target = sum(scores) // num_classes
class_score = [model.NewIntVar(0, 100*40, f'score_{c}') for c in range(num_classes)]
for c in range(num_classes):
    model.Add(class_score[c] == sum(scores[i]*x[i][c] for i in range(n)))

dev = [model.NewIntVar(0, 100*40, f'dev_{c}') for c in range(num_classes)]
for c in range(num_classes):
    tmp = model.NewIntVar(-100*40, 100*40, f'diff_{c}')
    model.Add(tmp == class_score[c] - target)
    model.AddAbsEquality(dev[c], tmp)
dev_max = model.NewIntVar(0, 100*40, 'dev_max')
model.AddMaxEquality(dev_max, dev)

# (5) ë¹„ë“±êµ ê· ë“±
at_risk = df.index[df['ë¹„ë“±êµ']].tolist()
lb, ub = bounds(len(at_risk))
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in at_risk) >= lb)
    model.Add(sum(x[i][c] for i in at_risk) <= ub)

# (6) ë‚¨ë…€ ê· ë“±
boys = df.index[df['sex']=='boy'].tolist()
girls= df.index[df['sex']=='girl'].tolist()
lb_b, ub_b = bounds(len(boys))
lb_g, ub_g = bounds(len(girls))
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in boys) >= lb_b)
    model.Add(sum(x[i][c] for i in boys) <= ub_b)
    model.Add(sum(x[i][c] for i in girls) >= lb_g)
    model.Add(sum(x[i][c] for i in girls) <= ub_g)

# (7) ìš´ë™ ê· ë“±
sports = df.index[df['ìš´ë™ì„ í˜¸']].tolist()
lb, ub = bounds(len(sports))
for c in range(num_classes):
    model.Add(sum(x[i][c] for i in sports) >= lb)
    model.Add(sum(x[i][c] for i in sports) <= ub)

# (8) ì „ë…„ë„ í•™ê¸‰ ë¶„ì‚°
for g, group_df in df.groupby('24ë…„ í•™ê¸‰'):
    idxs = group_df.index.tolist()
    lb, ub = bounds(len(idxs))
    for c in range(num_classes):
        model.Add(sum(x[i][c] for i in idxs) >= lb)
        model.Add(sum(x[i][c] for i in idxs) <= ub)

# (9) í´ëŸ½ ë¶„ì‚°
for g, group_df in df.groupby('í´ëŸ½'):
    idxs = group_df.index.tolist()
    lb, ub = bounds(len(idxs))
    for c in range(num_classes):
        model.Add(sum(x[i][c] for i in idxs) >= lb)
        model.Add(sum(x[i][c] for i in idxs) <= ub)

# ëª©ì í•¨ìˆ˜: ì„±ì  í¸ì°¨ ìµœì†Œí™”
model.Minimize(dev_max)

solver = cp_model.CpSolver()
solver.parameters.max_time_in_seconds = 60
solver.parameters.num_search_workers = 8

res = solver.Solve(model)
print("Status:", solver.StatusName(res))

assign = []
for i in range(n):
    c = max(range(num_classes), key=lambda k: solver.Value(x[i][k]))
    assign.append(c)

df_out = df.copy()
df_out['new_class'] = [a+1 for a in assign]

# ë°˜ë³„ ìš”ì•½
def cnt(mask, cls):
    idxs = df.index[mask].tolist()
    return sum(solver.Value(x[i][cls]) for i in idxs)

print("\n=== ë°˜ë³„ ìš”ì•½ ===")
for c in range(num_classes):
    male = cnt(df['sex']=='boy', c)
    female = cnt(df['sex']=='girl', c)
    lead = cnt(df['Leadership'], c)
    piano= cnt(df['Piano'], c)
    risk = cnt(df['ë¹„ë“±êµ'], c)
    sport= cnt(df['ìš´ë™ì„ í˜¸'], c)
    sc = solver.Value(class_score[c])
    print(f'ë°˜ {c+1}: ì¸ì› {class_size[c]}, ë‚¨ {male}, ì—¬ {female}, ë¦¬ë” {lead}, í”¼ì•„ë…¸ {piano}, ìœ„í—˜ {risk}, ìš´ë™ {sport}, ì´ì  {sc}')

# CSV ì €ì¥
df_out.to_csv('class_assignment.csv', index=False)
print("\nì €ì¥ ì™„ë£Œ: class_assignment.csv")

# === ìë™ ì»¬ëŸ¼íƒì§€ + ê²€ì¦ ì…€ (KeyError: 'class' ìˆ˜ì •) ===
import pandas as pd
import numpy as np
from math import ceil

def pick_col(cols, candidates):
    for c in candidates:
        if c in cols:
            return c
    return None

# 1) ë°ì´í„° ë¡œë“œ
df = pd.read_csv("á„’á…¡á†¨á„€á…³á†¸á„‡á…¡á†«á„‘á…§á†«á„‰á…¥á†¼CSP á„†á…®á†«á„Œá…¦ á„‹á…µá†¸á„…á…§á†¨á„‘á…¡á„‹á…µá†¯.csv")
assign = pd.read_csv("class_assignment.csv")

if "new_class" in assign.columns:
    assign = assign.rename(columns={"new_class": "class"})

# 2) id / class ì»¬ëŸ¼ ìë™ íƒì§€
id_in_df     = pick_col(df.columns,     ["id","ID","Id","í•™ìƒID","student_id"])
id_in_assign = pick_col(assign.columns, ["id","ID","Id","í•™ìƒID","student_id"])
class_in_assign = pick_col(assign.columns, ["class","Class","ë°˜","ë°˜ë²ˆí˜¸","ë°˜_ë²ˆí˜¸","class_id","classId"])

# idê°€ ì¸ë±ìŠ¤ì— ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ë³´ì •
if id_in_assign is None and assign.index.name in ["id","ID","Id"]:
    assign = assign.reset_index()
    id_in_assign = pick_col(assign.columns, ["id","ID","Id"])

if id_in_df is None or id_in_assign is None or class_in_assign is None:
    raise ValueError(
        f"[ì»¬ëŸ¼ í™•ì¸ í•„ìš”]\n"
        f"- ì›ë³¸ df.columns: {df.columns.tolist()}\n"
        f"- ë°°ì • assign.columns: {assign.columns.tolist()}\n"
        f"ìœ„ ëª©ë¡ì—ì„œ id ë˜ëŠ” class(ë°˜) ì»¬ëŸ¼ëª…ì„ í•˜ë‚˜ë¡œ ì •í•´ì£¼ì„¸ìš”."
    )

# 3) ì»¬ëŸ¼ í‘œì¤€í™” í›„ ë¨¸ì§€
df = df.rename(columns={id_in_df: "id"})
assign = assign.rename(columns={id_in_assign: "id", class_in_assign: "class"})
df = df.merge(assign[["id","class"]], on="id", how="inner")

num_classes = df["class"].nunique()
sizes = df["class"].value_counts().sort_index()
print("ë°˜ë³„ ì¸ì›:", dict(sizes))

def ok(msg, cond, detail=None):
    print(("âœ… " if cond else "âŒ ") + msg)
    if (not cond) and detail is not None:
        print(detail)

all_ok = True

# (0) ë°˜ ì¸ì›: 33Ã—4, 34Ã—2
size_ok = sorted(sizes.tolist()) == sorted([33,33,33,33,34,34])
ok("ë°˜ ì¸ì›: 33Ã—4, 34Ã—2", size_ok, sizes)
all_ok &= size_ok

# (1-A) ë¬¸ì œì•„ë™(ë‚˜ìœê´€ê³„) í˜ì–´ ê°™ì€ ë°˜ ê¸ˆì§€
bad_pairs = []
if "ë‚˜ìœê´€ê³„" in df.columns:
    for _, r in df.dropna(subset=["ë‚˜ìœê´€ê³„"]).iterrows():
        try:
            other = int(r["ë‚˜ìœê´€ê³„"])
            same = int(df.loc[df["id"]==other, "class"].iloc[0]) == int(r["class"])
            if same: bad_pairs.append((int(r["id"]), other, int(r["class"])))
        except Exception:
            pass
ok("ë¬¸ì œì•„ë™-ìƒëŒ€(ë‚˜ìœê´€ê³„) ê°™ì€ ë°˜ ê¸ˆì§€", len(bad_pairs)==0, bad_pairs if bad_pairs else None)
all_ok &= (len(bad_pairs)==0)

# (1-B) ë¹„ë“±êµ ìœ„í—˜ ì•„ë™ì€ 'ì¢‹ì€ê´€ê³„' ì¹œêµ¬ì™€ ê°™ì€ ë°˜
need_pairs, miss_pairs = [], []
if {"ë¹„ë“±êµ","ì¢‹ì€ê´€ê³„"}.issubset(df.columns):
    needy = df[df["ë¹„ë“±êµ"].astype(str).str.lower().eq("yes")]
    for _, r in needy.iterrows():
        if pd.isna(r["ì¢‹ì€ê´€ê³„"]):
            miss_pairs.append(int(r["id"]))
        else:
            try:
                g = int(r["ì¢‹ì€ê´€ê³„"])
                same = int(df.loc[df["id"]==g, "class"].iloc[0]) == int(r["class"])
                if not same: need_pairs.append((int(r["id"]), g, int(r["class"])))
            except Exception:
                miss_pairs.append(int(r["id"]))
cond_1B = (len(need_pairs)==0)
ok("ë¹„ë“±êµ ìœ„í—˜ ì•„ë™ì´ ë³´í˜¸ ì¹œêµ¬ì™€ ê°™ì€ ë°˜", cond_1B, need_pairs if need_pairs else None)
if miss_pairs:
    print("â„¹ï¸ ë³´í˜¸ ì¹œêµ¬ ë¯¸ì§€ì •(ê³µë€):", miss_pairs)
all_ok &= cond_1B

# (2) ê° ë°˜ ë¦¬ë” â‰¥ 1
missing_leader = []
if "Leadership" in df.columns:
    leaders = df[df["Leadership"].astype(str).str.lower().eq("yes")].groupby("class")["id"].count()
    missing_leader = [c for c in sorted(df["class"].unique()) if leaders.get(c,0)<1]
ok("ê° ë°˜ ë¦¬ë” ìµœì†Œ 1ëª…", len(missing_leader)==0, missing_leader if missing_leader else None)
all_ok &= (len(missing_leader)==0)

# (3) í”¼ì•„ë…¸ ê· ë“±(ì°¨ì´ â‰¤ 1)
if "Piano" in df.columns:
    piano = df[df["Piano"].astype(str).str.lower().eq("yes")].groupby("class")["id"].count()
    piano = piano.reindex(sorted(df["class"].unique()), fill_value=0)
    ok("í”¼ì•„ë…¸ ì¸ì› ê· ë“±(ì°¨ì´ â‰¤ 1)", piano.max()-piano.min()<=1, dict(piano))
    all_ok &= (piano.max()-piano.min()<=1)

# (4) ì„±ì  í‰ê·  ë²”ìœ„ â‰¤ 5 (í•„ìš”ì‹œ ê¸°ì¤€ ì¡°ì •)
if "score" in df.columns:
    avg = df.groupby("class")["score"].mean()
    spread = avg.max()-avg.min()
    ok(f"ì„±ì  ê· í˜•(ë°˜ í‰ê·  ë²”ìœ„ â‰¤ 5) | ì‹¤ì œ={spread:.2f}", spread<=5, avg)
    all_ok &= (spread<=5)

# (5) ìœ„í—˜(ë¬¸ì œ) ì•„ë™ ìˆ˜ ê· ë“±(ì°¨ì´ â‰¤ 1) â€“ ë‚˜ìœê´€ê³„ notna ì¹´ìš´íŠ¸
if "ë‚˜ìœê´€ê³„" in df.columns:
    risk = df.index[df['ë‚˜ìœê´€ê³„'].notna()].tolist()   # ìœ„í—˜ ì•„ë™ id
    lb, ub = bounds(len(risk))  # floor/ceil ë¶„ë°°
    for c in range(num_classes):
        model.Add(sum(x[i][c] for i in risk) >= lb)
        model.Add(sum(x[i][c] for i in risk) <= ub)

# (6) ë‚¨ì ìˆ˜ ê· ë“±(ì°¨ì´ â‰¤ 1)
if "sex" in df.columns:
    boys = df[df["sex"].astype(str).str.lower().eq("boy")].groupby("class")["id"].count()
    boys = boys.reindex(sorted(df["class"].unique()), fill_value=0)
    ok("ë‚¨ì ìˆ˜ ê· ë“±(ì°¨ì´ â‰¤ 1)", boys.max()-boys.min()<=1, dict(boys))
    all_ok &= (boys.max()-boys.min()<=1)

# (7) ìš´ë™ ì„ í˜¸ ê· ë“±(ì°¨ì´ â‰¤ 1)
if "ìš´ë™ì„ í˜¸" in df.columns:
    sport = df[df["ìš´ë™ì„ í˜¸"].astype(str).str.lower().eq("yes")].groupby("class")["id"].count()
    sport = sport.reindex(sorted(df["class"].unique()), fill_value=0)
    ok("ìš´ë™ ì„ í˜¸ ì¸ì› ê· ë“±(ì°¨ì´ â‰¤ 1)", sport.max()-sport.min()<=1, dict(sport))
    all_ok &= (sport.max()-sport.min()<=1)

# (8) ì „ë…„ë„ í•™ê¸‰ ë™ë°˜ ê³¼ë°€ ë°©ì§€
if "24ë…„ í•™ê¸‰" in df.columns:
    ct = pd.crosstab(df["24ë…„ í•™ê¸‰"], df["class"])
    bad_cells = []
    for r in ct.index:
        n_r = int(ct.loc[r].sum())
        cap = ceil(n_r/num_classes)
        for c in ct.columns:
            v = int(ct.loc[r, c])
            if v>cap: bad_cells.append((r,c,v,cap))
    ok("ì „ë…„ë„ ë™ë°˜ ê³¼ë°€ ë°©ì§€(ê° ì…€ â‰¤ ceil(n_r/6))", len(bad_cells)==0, bad_cells if bad_cells else None)
    all_ok &= (len(bad_cells)==0)

# (9) í´ëŸ½ í¸í–¥ ë°©ì§€(í´ëŸ½ë³„ ë¶„í¬ ì°¨ì´ â‰¤ 1)
club_ok = True
if "í´ëŸ½" in df.columns:
    for club, sub in df.groupby("í´ëŸ½"):
        cnt = sub.groupby("class")["id"].count().reindex(sorted(df["class"].unique()), fill_value=0)
        if cnt.max()-cnt.min()>1:
            club_ok = False
            print("âŒ í´ëŸ½ í¸í–¥:", club, dict(cnt))
ok("í´ëŸ½ í¸í–¥ ë°©ì§€(ê° í´ëŸ½ ë¶„í¬ ì°¨ì´ â‰¤ 1)", club_ok)
all_ok &= club_ok

print("\n=== ìµœì¢… íŒì • ===")
print("ğŸ‰ ëª¨ë“  ì œì•½ ì¶©ì¡±!" if all_ok else "âš ï¸ ì¼ë¶€ ì œì•½ ìœ„ë°˜ì´ ìˆìŠµë‹ˆë‹¤. ìœ„ì˜ âŒ í•­ëª©ì„ í™•ì¸í•˜ì„¸ìš”.")